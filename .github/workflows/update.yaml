name: Update Slug Page from Template

on:
  repository_dispatch:
    types: [update-slug-from-template]

jobs:
  update-slug:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3

      - name: Clone template repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/Barbarpotato/labs-detail-template.git temp-template

      - name: Replace [slug].js file
        run: |
          cp temp-template/src/pages/[slug].js src/pages/[slug].js

      - name: Inject index query param into fetch URL
        run: |
          FILE_PATH="src/pages/[slug].js"
          INDEX=${{ github.event.client_payload.index }}

          echo "Index value: $INDEX"

          if [ -f "$FILE_PATH" ]; then
            sed -i "s|\(index=\)[^'\"]*|\1${INDEX}|" "$FILE_PATH"
          else
            echo "File not found: $FILE_PATH"
            exit 1
          fi

      - name: Commit and push changes
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/pages/[slug].js
          git commit -m "Update [slug].js with dynamic index" || echo "No changes to commit"
          git push https://x-access-token:${GH_PAT}@github.com/${{ github.repository }} HEAD:main
